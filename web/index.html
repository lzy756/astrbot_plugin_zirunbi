<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孜然币模拟炒股 Web 版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --up-color: #e74c3c;
            --down-color: #2ecc71;
            --nav-bg-start: #0f172a;
            --nav-bg-end: #1e293b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025);
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(90deg, var(--nav-bg-start), var(--nav-bg-end)) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Cards */
        .card-shadow { 
            background: var(--card-bg);
            box-shadow: var(--shadow-md); 
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-shadow:hover {
            box-shadow: var(--shadow-lg);
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--text-main);
            border-top-left-radius: var(--radius-md) !important;
            border-top-right-radius: var(--radius-md) !important;
        }
        .card-body {
            padding: 1.5rem;
        }

        /* Market List */
        .market-list-item { 
            cursor: pointer; 
            transition: all 0.2s ease;
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            margin-bottom: 0;
        }
        .market-list-item:last-child {
            border-bottom: none;
        }
        .market-list-item:hover { 
            background-color: #f8fafc; 
        }
        .market-list-item.active { 
            background-color: #eff6ff; 
            border-left: 4px solid var(--primary-color); 
            color: var(--text-main);
        }

        /* Typography & Colors */
        .price-up { color: var(--up-color) !important; font-weight: 600; }
        .price-down { color: var(--down-color) !important; font-weight: 600; }
        
        /* Chart */
        #kline-chart { width: 100%; height: 520px; }
        
        /* Login View */
        .login-container { 
            max-width: 420px; 
            margin-top: 10vh; 
            margin-bottom: 10vh;
        }
        .login-card {
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .login-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 2.5rem 2rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .login-body {
            padding: 2rem;
        }

        /* Forms & Buttons */
        .form-control {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border: 1px solid #cbd5e1;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.95rem;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.15);
        }
        .input-group-text {
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
        }
        .btn {
            border-radius: 8px;
            padding: 0.5rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Trade Panel */
        .btn-outline-danger {
            color: var(--up-color);
            border-color: var(--up-color);
        }
        .btn-outline-danger:hover, .btn-check:checked + .btn-outline-danger {
            background-color: var(--up-color);
            border-color: var(--up-color);
            color: white;
        }
        .btn-outline-success {
            color: var(--down-color);
            border-color: var(--down-color);
        }
        .btn-outline-success:hover, .btn-check:checked + .btn-outline-success {
            background-color: var(--down-color);
            border-color: var(--down-color);
            color: white;
        }

        /* Utilities */
        #app-content { display: none; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            border: none;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<div class="container login-container" id="login-view">
    <div class="card card-shadow login-card">
        <div class="login-header text-center">
            <h3 class="mb-0 fw-bold"><i class="bi bi-graph-up-arrow text-primary me-2"></i>孜然币模拟交易</h3>
        </div>
        <div class="card-body login-body">
            <div class="mb-4">
                <label class="form-label fw-medium text-muted small text-uppercase">QQ账号</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-person text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="login-uid" placeholder="请输入您的QQ号">
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-medium text-muted small text-uppercase">交易密码</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-shield-lock text-muted"></i></span>
                    <input type="password" class="form-control border-start-0 ps-0" id="login-pwd" placeholder="Bot处注册的密码">
                </div>
            </div>
            <div class="d-grid mt-2">
                <button class="btn btn-primary btn-lg shadow-sm" onclick="handleLogin()">
                    <i class="bi bi-box-arrow-in-right me-2"></i>登 录
                </button>
            </div>
            <div class="mt-4 text-center text-muted small">
                <i class="bi bi-info-circle me-1"></i>请先在 Bot 私聊发送 <code class="bg-light px-2 py-1 rounded text-primary">/zrb register &lt;密码&gt;</code> 获取密码
            </div>
        </div>
    </div>
</div>

<div id="app-content">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-graph-up-arrow text-primary me-2 fs-4"></i>
                <span>孜然币交易所</span>
            </a>
            <div class="d-flex text-light align-items-center">
                <div class="d-flex align-items-center me-4 bg-white bg-opacity-10 px-3 py-1 rounded-pill">
                    <i class="bi bi-person-circle me-2 opacity-75"></i>
                    <span id="nav-user-id" class="fw-medium">--</span>
                </div>
                <button class="btn btn-outline-light btn-sm px-3 rounded-pill" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>退出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card card-shadow h-100">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-bar-chart-line text-primary me-2 fs-5"></i>
                        <span>市场行情</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="market-list"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-shadow mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-activity text-primary me-2 fs-5"></i>
                            <span class="fw-bold" id="chart-title">选择币种查看K线</span>
                        </div>
                        <span class="badge rounded-pill px-3 py-2 fw-medium" id="market-status-badge" style="font-size: 0.85rem;">--</span>
                    </div>
                    <div class="card-body p-2 p-md-3">
                        <div id="kline-chart"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card card-shadow mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-wallet2 text-primary me-2 fs-5"></i>
                        <span>我的资产</span>
                    </div>
                    <div class="card-body">
                        <div class="text-muted small mb-1">可用余额 (CNY)</div>
                        <h3 class="mb-4 fw-bold text-dark">¥ <span id="asset-balance">0.00</span></h3>
                        <div class="text-muted small mb-2 fw-medium">持仓明细</div>
                        <div id="asset-holdings" class="pe-2" style="max-height: 220px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div class="card card-shadow">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-arrow-left-right text-primary me-2 fs-5"></i>
                        <span>快速交易</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-medium">交易币种</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-coin text-muted"></i></span>
                                <input type="text" class="form-control bg-light fw-bold" id="trade-symbol" readonly value="--">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-medium">交易方向</label>
                            <div class="btn-group w-100 shadow-sm" role="group">
                                <input type="radio" class="btn-check" name="trade-action" id="action-buy" value="buy" checked>
                                <label class="btn btn-outline-danger fw-medium py-2" for="action-buy">买入 (Buy)</label>
                                <input type="radio" class="btn-check" name="trade-action" id="action-sell" value="sell">
                                <label class="btn btn-outline-success fw-medium py-2" for="action-sell">卖出 (Sell)</label>
                            </div>
                        </div>
                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <label class="form-label text-muted small fw-medium">委托价格</label>
                                <input type="number" class="form-control" id="trade-price" placeholder="市价单">
                            </div>
                            <div class="col-6">
                                <label class="form-label text-muted small fw-medium">交易数量</label>
                                <input type="number" class="form-control" id="trade-amount" placeholder="0.0">
                            </div>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary py-2 fw-bold shadow-sm" onclick="submitTrade()">
                                <i class="bi bi-check2-circle me-1"></i>提交订单
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let currentSymbol = null;
    let marketPrices = {};
    let chartInstance = null;
    let refreshInterval = null;
    let klineRefreshInterval = null;

    let klineCache = {};
    let klineLastTime = {};

    function showToast(message, type) {
        type = type || 'info';
        const colorMap = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary', warning: 'bg-warning' };
        const container = document.getElementById('toast-container');
        const id = 'toast-' + Date.now();
        const html = '<div id="' + id + '" class="toast align-items-center text-white ' + (colorMap[type] || 'bg-primary') + ' border-0 show" role="alert">' +
            '<div class="d-flex"><div class="toast-body">' + message + '</div>' +
            '<button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest(\'.toast\').remove()"></button>' +
            '</div></div>';
        container.insertAdjacentHTML('beforeend', html);
        setTimeout(function() {
            const el = document.getElementById(id);
            if (el) el.remove();
        }, 4000);
    }

    function ensureChartInitialized() {
        if (!chartInstance) {
            chartInstance = echarts.init(document.getElementById('kline-chart'));
            window.addEventListener('resize', function() {
                if (chartInstance) chartInstance.resize();
            });
        }
        chartInstance.resize();
    }

    document.addEventListener('DOMContentLoaded', function() {
        checkSession();
    });

    async function checkSession() {
        try {
            const res = await fetch('/api/me');
            if (res.ok) {
                const data = await res.json();
                currentUser = { user_id: data.user_id };
                initApp();
            } else {
                showLoginView();
            }
        } catch (e) {
            showLoginView();
        }
    }

    function showLoginView() {
        document.getElementById('login-view').style.display = 'block';
        document.getElementById('app-content').style.display = 'none';
    }

    async function handleLogin() {
        const uid = document.getElementById('login-uid').value;
        const pwd = document.getElementById('login-pwd').value;

        if (!uid || !pwd) { showToast('请输入完整信息', 'warning'); return; }

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: uid, password: pwd})
            });
            const data = await res.json();

            if (res.ok) {
                currentUser = { user_id: data.user_id };
                document.getElementById('login-view').style.display = 'none';
                initApp();
                showToast('登录成功', 'success');
            } else {
                showToast(data.detail || '登录失败', 'error');
            }
        } catch (e) {
            showToast('网络错误: ' + e, 'error');
        }
    }

    async function logout() {
        try { await fetch('/api/logout', { method: 'POST' }); } catch(e) {}
        currentUser = null;
        if (refreshInterval) clearInterval(refreshInterval);
        if (klineRefreshInterval) clearInterval(klineRefreshInterval);
        location.reload();
    }

    function initApp() {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('nav-user-id').innerText = currentUser.user_id;

        requestAnimationFrame(function() {
            ensureChartInitialized();
        });

        refreshData();
        refreshInterval = setInterval(refreshData, 3000);
        klineRefreshInterval = setInterval(refreshKline, 300000);
    }

    async function refreshData() {
        if (!currentUser) return;

        try {
            const res = await fetch('/api/market');
            if (res.status === 401) { showLoginView(); return; }
            const data = await res.json();
            marketPrices = data.prices;
            renderMarketList(data.prices);

            const badge = document.getElementById('market-status-badge');
            badge.innerText = data.is_open ? '交易中' : '休市';
            badge.className = data.is_open ? 'badge bg-success' : 'badge bg-secondary';
        } catch (e) { console.error('Market fetch error', e); }

        try {
            const res = await fetch('/api/assets');
            if (res.status === 401) { showLoginView(); return; }
            const data = await res.json();
            renderAssets(data);
        } catch (e) { console.error('Asset fetch error', e); }
    }

    function renderMarketList(prices) {
        const list = document.getElementById('market-list');
        list.innerHTML = '';

        const symbols = Object.keys(prices);
        if (!currentSymbol && symbols.length > 0) {
            selectSymbol(symbols[0]);
        }

        symbols.forEach(function(sym) {
            const price = prices[sym];
            const item = document.createElement('div');
            item.className = 'list-group-item market-list-item d-flex justify-content-between align-items-center ' + (sym === currentSymbol ? 'active' : '');
            item.onclick = function() { selectSymbol(sym); };
            item.innerHTML = '<span class="fw-bold">' + sym + '</span>' +
                '<span class="' + (sym === currentSymbol ? 'text-dark' : 'text-primary') + '">' + price.toFixed(2) + '</span>';
            list.appendChild(item);
        });
    }

    function renderAssets(data) {
        document.getElementById('asset-balance').innerText = data.balance.toFixed(2);
        const container = document.getElementById('asset-holdings');

        if (data.holdings.length === 0) {
            container.innerHTML = '<div class="text-muted text-center mt-3">暂无持仓</div>';
            return;
        }

        let html = '<ul class="list-group list-group-flush small">';
        data.holdings.forEach(function(h) {
            const price = marketPrices[h.symbol] || 0;
            const val = price * h.amount;
            html += '<li class="list-group-item d-flex justify-content-between px-0">' +
                '<span>' + h.symbol + '</span>' +
                '<span class="text-end">' +
                '<div>' + h.amount.toFixed(4) + '</div>' +
                '<div class="text-muted" style="font-size:0.8em">\u2248 \u00a5' + val.toFixed(2) + '</div>' +
                '</span></li>';
        });
        html += '</ul>';
        container.innerHTML = html;
    }

    async function selectSymbol(sym) {
        if (currentSymbol === sym) return;
        currentSymbol = sym;

        document.getElementById('trade-symbol').value = sym;
        document.getElementById('chart-title').innerText = sym + ' K线走势';

        renderMarketList(marketPrices);

        klineCache[sym] = null;
        klineLastTime[sym] = null;
        await loadFullKline(sym);
    }

    async function loadFullKline(sym) {
        ensureChartInitialized();
        chartInstance.showLoading();
        try {
            const res = await fetch('/api/kline/' + sym);
            const data = await res.json();
            klineCache[sym] = data.data;
            if (data.data.length > 0) {
                klineLastTime[sym] = data.data[data.data.length - 1].time;
            }
            renderChart(sym, data.data);
        } catch (e) {
            console.error(e);
        } finally {
            chartInstance.hideLoading();
        }
    }

    async function refreshKline() {
        if (!currentSymbol) return;
        const sym = currentSymbol;
        const since = klineLastTime[sym];
        if (!since) return;

        try {
            const res = await fetch('/api/kline/' + sym + '?since=' + encodeURIComponent(since));
            const data = await res.json();
            if (data.data.length > 0) {
                const cached = klineCache[sym] || [];
                const merged = cached.concat(data.data);
                klineCache[sym] = merged;
                klineLastTime[sym] = merged[merged.length - 1].time;

                const opt = chartInstance.getOption();
                let zoomState = null;
                if (opt && opt.dataZoom && opt.dataZoom.length > 0) {
                    zoomState = { start: opt.dataZoom[0].start, end: opt.dataZoom[0].end };
                }

                renderChart(sym, merged, zoomState);
            }
        } catch (e) {
            console.error('KLine refresh error', e);
        }
    }

    function renderChart(symbol, rawData, zoomState) {
        ensureChartInitialized();
        if (!rawData || rawData.length === 0) {
            chartInstance.clear();
            return;
        }

        var dates = rawData.map(function(item) { return item.time; });
        var ohlc = rawData.map(function(item) { return [item.open, item.close, item.low, item.high]; });
        var volColors = rawData.map(function(item) { return item.close >= item.open ? 1 : -1; });
        var volData = rawData.map(function(item) { return item.volume; });

        var zoomStart = 0;
        var zoomEnd = 100;
        if (zoomState) {
            zoomStart = zoomState.start;
            zoomEnd = zoomState.end;
        } else if (rawData.length > 60) {
            zoomStart = Math.max(0, 100 - (60 / rawData.length) * 100);
        }

        var option = {
            animation: false,
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function(params) {
                    if (!params || params.length === 0) return '';
                    var d = params[0];
                    var idx = d.dataIndex;
                    var item = rawData[idx];
                    if (!item) return '';
                    var color = item.close >= item.open ? '#dc3545' : '#198754';
                    var change = item.close - item.open;
                    var changePct = item.open !== 0 ? (change / item.open * 100).toFixed(2) : '0.00';
                    var sign = change >= 0 ? '+' : '';
                    return '<div style="font-size:13px;line-height:1.8">' +
                        '<b>' + item.time + '</b><br/>' +
                        '<span style="color:' + color + '">' + symbol + '</span><br/>' +
                        '开盘: <b>' + item.open.toFixed(2) + '</b><br/>' +
                        '收盘: <b>' + item.close.toFixed(2) + '</b><br/>' +
                        '最高: <b>' + item.high.toFixed(2) + '</b><br/>' +
                        '最低: <b>' + item.low.toFixed(2) + '</b><br/>' +
                        '涨跌: <span style="color:' + color + '">' + sign + change.toFixed(2) + ' (' + sign + changePct + '%)</span><br/>' +
                        '成交量: ' + item.volume.toFixed(2) +
                        '</div>';
                }
            },
            axisPointer: {
                link: [{ xAxisIndex: 'all' }],
                label: { backgroundColor: '#555' }
            },
            grid: [
                { left: 60, right: 30, top: 20, bottom: '30%' },
                { left: 60, right: 30, height: 60, bottom: 50 }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { onZero: false, lineStyle: { color: '#ccc' } },
                    splitLine: { show: false },
                    axisLabel: {
                        fontSize: 11,
                        color: '#666',
                        formatter: function(val) {
                            return val.substring(5);
                        }
                    }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { onZero: false },
                    axisTick: { show: false },
                    splitLine: { show: false },
                    axisLabel: { show: false }
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: { show: true, areaStyle: { color: ['rgba(250,250,250,0.3)', 'rgba(240,240,240,0.3)'] } },
                    splitLine: { lineStyle: { color: '#eee' } },
                    axisLabel: {
                        fontSize: 11,
                        color: '#666',
                        formatter: function(val) { return val.toFixed(2); }
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                { type: 'inside', xAxisIndex: [0, 1], start: zoomStart, end: zoomEnd },
                { show: true, xAxisIndex: [0, 1], type: 'slider', bottom: 10, height: 25, start: zoomStart, end: zoomEnd,
                  borderColor: '#ccc', fillerColor: 'rgba(13,110,253,0.15)', handleStyle: { color: '#0d6efd' } }
            ],
            series: [
                {
                    name: symbol,
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#dc3545',
                        color0: '#198754',
                        borderColor: '#dc3545',
                        borderColor0: '#198754'
                    },
                    barMaxWidth: 20
                },
                {
                    name: 'Volume',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volData,
                    barMaxWidth: 16,
                    itemStyle: {
                        color: function(params) {
                            return volColors[params.dataIndex] > 0 ? 'rgba(220,53,69,0.5)' : 'rgba(25,135,84,0.5)';
                        }
                    }
                }
            ]
        };

        chartInstance.setOption(option, true);
    }

    async function submitTrade() {
        const action = document.querySelector('input[name="trade-action"]:checked').value;
        const amount = parseFloat(document.getElementById('trade-amount').value);
        const priceStr = document.getElementById('trade-price').value;
        const price = priceStr ? parseFloat(priceStr) : null;

        if (!currentSymbol || !amount) { showToast('请填写完整', 'warning'); return; }

        try {
            const res = await fetch('/api/trade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: currentSymbol,
                    amount: amount,
                    price: price,
                    action: action
                })
            });
            const data = await res.json();
            if (res.status === 401) { showLoginView(); return; }
            if (res.ok) {
                showToast('订单提交成功! ID: ' + data.order_id + ' 状态: ' + data.order_status, 'success');
                document.getElementById('trade-amount').value = '';
                document.getElementById('trade-price').value = '';
                refreshData();
            } else {
                showToast('交易失败: ' + data.detail, 'error');
            }
        } catch (e) {
            showToast('网络错误: ' + e, 'error');
        }
    }
</script>
</body>
</html>

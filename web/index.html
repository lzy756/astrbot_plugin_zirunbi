<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­œç„¶å¸æ¨¡æ‹Ÿç‚’è‚¡ Web ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .market-list-item { cursor: pointer; transition: background-color 0.2s; }
        .market-list-item:hover { background-color: #f1f3f5; }
        .market-list-item.active { background-color: #e9ecef; border-left: 4px solid #0d6efd; }
        .price-up { color: #dc3545; font-weight: bold; }
        .price-down { color: #198754; font-weight: bold; }
        #kline-chart { width: 100%; height: 520px; }
        .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .login-container { max-width: 400px; margin-top: 100px; }
        #app-content { display: none; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<div class="container login-container" id="login-view">
    <div class="card card-shadow">
        <div class="card-body p-4">
            <h3 class="text-center mb-4">ğŸ“ˆ å­œç„¶å¸æ¨¡æ‹Ÿäº¤æ˜“</h3>
            <div class="mb-3">
                <label class="form-label">QQè´¦å·</label>
                <input type="text" class="form-control" id="login-uid" placeholder="è¯·è¾“å…¥æ‚¨çš„QQå·">
            </div>
            <div class="mb-3">
                <label class="form-label">äº¤æ˜“å¯†ç </label>
                <input type="password" class="form-control" id="login-pwd" placeholder="Botå¤„æ³¨å†Œçš„å¯†ç ">
            </div>
            <div class="d-grid">
                <button class="btn btn-primary btn-lg" onclick="handleLogin()">ç™» å½•</button>
            </div>
            <div class="mt-3 text-center text-muted small">
                è¯·å…ˆåœ¨ Bot ç§èŠå‘é€ <code>/zrb register &lt;å¯†ç &gt;</code> è·å–å¯†ç 
            </div>
        </div>
    </div>
</div>

<div id="app-content">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ğŸ“ˆ å­œç„¶å¸äº¤æ˜“æ‰€</a>
            <div class="d-flex text-light align-items-center">
                <span class="me-3">ğŸ‘¤ <span id="nav-user-id">--</span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card card-shadow h-100">
                    <div class="card-header bg-white fw-bold">ğŸ“Š å¸‚åœºè¡Œæƒ…</div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="market-list"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-shadow mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold" id="chart-title">é€‰æ‹©å¸ç§æŸ¥çœ‹Kçº¿</span>
                        <span class="badge bg-secondary" id="market-status-badge">--</span>
                    </div>
                    <div class="card-body">
                        <div id="kline-chart"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card card-shadow mb-4">
                    <div class="card-header bg-white fw-bold">ğŸ’° æˆ‘çš„èµ„äº§</div>
                    <div class="card-body">
                        <h4 class="mb-3">Â¥ <span id="asset-balance">0.00</span></h4>
                        <div id="asset-holdings" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div class="card card-shadow">
                    <div class="card-header bg-white fw-bold">ğŸ’¸ å¿«é€Ÿäº¤æ˜“</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">å¸ç§</label>
                            <input type="text" class="form-control" id="trade-symbol" readonly value="--">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ–¹å‘</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="trade-action" id="action-buy" value="buy" checked>
                                <label class="btn btn-outline-danger" for="action-buy">ä¹°å…¥ (Buy)</label>
                                <input type="radio" class="btn-check" name="trade-action" id="action-sell" value="sell">
                                <label class="btn btn-outline-success" for="action-sell">å–å‡º (Sell)</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä»·æ ¼</label>
                            <input type="number" class="form-control" id="trade-price" placeholder="ç•™ç©ºä¸ºå¸‚ä»·å•">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ•°é‡</label>
                            <input type="number" class="form-control" id="trade-amount" placeholder="0.0">
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="submitTrade()">æäº¤è®¢å•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let currentSymbol = null;
    let marketPrices = {};
    let chartInstance = null;
    let refreshInterval = null;
    let klineRefreshInterval = null;

    let klineCache = {};
    let klineLastTime = {};

    function showToast(message, type) {
        type = type || 'info';
        const colorMap = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary', warning: 'bg-warning' };
        const container = document.getElementById('toast-container');
        const id = 'toast-' + Date.now();
        const html = '<div id="' + id + '" class="toast align-items-center text-white ' + (colorMap[type] || 'bg-primary') + ' border-0 show" role="alert">' +
            '<div class="d-flex"><div class="toast-body">' + message + '</div>' +
            '<button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest(\'.toast\').remove()"></button>' +
            '</div></div>';
        container.insertAdjacentHTML('beforeend', html);
        setTimeout(function() {
            const el = document.getElementById(id);
            if (el) el.remove();
        }, 4000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        chartInstance = echarts.init(document.getElementById('kline-chart'));
        window.addEventListener('resize', function() { chartInstance.resize(); });

        checkSession();
    });

    async function checkSession() {
        try {
            const res = await fetch('/api/me');
            if (res.ok) {
                const data = await res.json();
                currentUser = { user_id: data.user_id };
                initApp();
            } else {
                showLoginView();
            }
        } catch (e) {
            showLoginView();
        }
    }

    function showLoginView() {
        document.getElementById('login-view').style.display = 'block';
        document.getElementById('app-content').style.display = 'none';
    }

    async function handleLogin() {
        const uid = document.getElementById('login-uid').value;
        const pwd = document.getElementById('login-pwd').value;

        if (!uid || !pwd) { showToast('è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯', 'warning'); return; }

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: uid, password: pwd})
            });
            const data = await res.json();

            if (res.ok) {
                currentUser = { user_id: data.user_id };
                document.getElementById('login-view').style.display = 'none';
                initApp();
                showToast('ç™»å½•æˆåŠŸ', 'success');
            } else {
                showToast(data.detail || 'ç™»å½•å¤±è´¥', 'error');
            }
        } catch (e) {
            showToast('ç½‘ç»œé”™è¯¯: ' + e, 'error');
        }
    }

    async function logout() {
        try { await fetch('/api/logout', { method: 'POST' }); } catch(e) {}
        currentUser = null;
        if (refreshInterval) clearInterval(refreshInterval);
        if (klineRefreshInterval) clearInterval(klineRefreshInterval);
        location.reload();
    }

    function initApp() {
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('nav-user-id').innerText = currentUser.user_id;

        refreshData();
        refreshInterval = setInterval(refreshData, 3000);
        klineRefreshInterval = setInterval(refreshKline, 10000);
    }

    async function refreshData() {
        if (!currentUser) return;

        try {
            const res = await fetch('/api/market');
            if (res.status === 401) { showLoginView(); return; }
            const data = await res.json();
            marketPrices = data.prices;
            renderMarketList(data.prices);

            const badge = document.getElementById('market-status-badge');
            badge.innerText = data.is_open ? 'äº¤æ˜“ä¸­' : 'ä¼‘å¸‚';
            badge.className = data.is_open ? 'badge bg-success' : 'badge bg-secondary';
        } catch (e) { console.error('Market fetch error', e); }

        try {
            const res = await fetch('/api/assets');
            if (res.status === 401) { showLoginView(); return; }
            const data = await res.json();
            renderAssets(data);
        } catch (e) { console.error('Asset fetch error', e); }
    }

    function renderMarketList(prices) {
        const list = document.getElementById('market-list');
        list.innerHTML = '';

        const symbols = Object.keys(prices);
        if (!currentSymbol && symbols.length > 0) {
            selectSymbol(symbols[0]);
        }

        symbols.forEach(function(sym) {
            const price = prices[sym];
            const item = document.createElement('div');
            item.className = 'list-group-item market-list-item d-flex justify-content-between align-items-center ' + (sym === currentSymbol ? 'active' : '');
            item.onclick = function() { selectSymbol(sym); };
            item.innerHTML = '<span class="fw-bold">' + sym + '</span>' +
                '<span class="' + (sym === currentSymbol ? 'text-dark' : 'text-primary') + '">' + price.toFixed(2) + '</span>';
            list.appendChild(item);
        });
    }

    function renderAssets(data) {
        document.getElementById('asset-balance').innerText = data.balance.toFixed(2);
        const container = document.getElementById('asset-holdings');

        if (data.holdings.length === 0) {
            container.innerHTML = '<div class="text-muted text-center mt-3">æš‚æ— æŒä»“</div>';
            return;
        }

        let html = '<ul class="list-group list-group-flush small">';
        data.holdings.forEach(function(h) {
            const price = marketPrices[h.symbol] || 0;
            const val = price * h.amount;
            html += '<li class="list-group-item d-flex justify-content-between px-0">' +
                '<span>' + h.symbol + '</span>' +
                '<span class="text-end">' +
                '<div>' + h.amount.toFixed(4) + '</div>' +
                '<div class="text-muted" style="font-size:0.8em">\u2248 \u00a5' + val.toFixed(2) + '</div>' +
                '</span></li>';
        });
        html += '</ul>';
        container.innerHTML = html;
    }

    async function selectSymbol(sym) {
        if (currentSymbol === sym) return;
        currentSymbol = sym;

        document.getElementById('trade-symbol').value = sym;
        document.getElementById('chart-title').innerText = sym + ' Kçº¿èµ°åŠ¿';

        renderMarketList(marketPrices);

        klineCache[sym] = null;
        klineLastTime[sym] = null;
        await loadFullKline(sym);
    }

    async function loadFullKline(sym) {
        chartInstance.showLoading();
        try {
            const res = await fetch('/api/kline/' + sym);
            const data = await res.json();
            klineCache[sym] = data.data;
            if (data.data.length > 0) {
                klineLastTime[sym] = data.data[data.data.length - 1].time;
            }
            renderChart(sym, data.data);
        } catch (e) {
            console.error(e);
        } finally {
            chartInstance.hideLoading();
        }
    }

    async function refreshKline() {
        if (!currentSymbol) return;
        const sym = currentSymbol;
        const since = klineLastTime[sym];
        if (!since) return;

        try {
            const res = await fetch('/api/kline/' + sym + '?since=' + encodeURIComponent(since));
            const data = await res.json();
            if (data.data.length > 0) {
                const cached = klineCache[sym] || [];
                const merged = cached.concat(data.data);
                klineCache[sym] = merged;
                klineLastTime[sym] = merged[merged.length - 1].time;

                const opt = chartInstance.getOption();
                let zoomState = null;
                if (opt && opt.dataZoom && opt.dataZoom.length > 0) {
                    zoomState = { start: opt.dataZoom[0].start, end: opt.dataZoom[0].end };
                }

                renderChart(sym, merged, zoomState);
            }
        } catch (e) {
            console.error('KLine refresh error', e);
        }
    }

    function renderChart(symbol, rawData, zoomState) {
        if (!rawData || rawData.length === 0) {
            chartInstance.clear();
            return;
        }

        var dates = rawData.map(function(item) { return item.time; });
        var ohlc = rawData.map(function(item) { return [item.open, item.close, item.low, item.high]; });
        var volColors = rawData.map(function(item) { return item.close >= item.open ? 1 : -1; });
        var volData = rawData.map(function(item) { return item.volume; });

        var zoomStart = 0;
        var zoomEnd = 100;
        if (zoomState) {
            zoomStart = zoomState.start;
            zoomEnd = zoomState.end;
        } else if (rawData.length > 60) {
            zoomStart = Math.max(0, 100 - (60 / rawData.length) * 100);
        }

        var option = {
            animation: false,
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function(params) {
                    if (!params || params.length === 0) return '';
                    var d = params[0];
                    var idx = d.dataIndex;
                    var item = rawData[idx];
                    if (!item) return '';
                    var color = item.close >= item.open ? '#dc3545' : '#198754';
                    var change = item.close - item.open;
                    var changePct = item.open !== 0 ? (change / item.open * 100).toFixed(2) : '0.00';
                    var sign = change >= 0 ? '+' : '';
                    return '<div style="font-size:13px;line-height:1.8">' +
                        '<b>' + item.time + '</b><br/>' +
                        '<span style="color:' + color + '">' + symbol + '</span><br/>' +
                        'å¼€ç›˜: <b>' + item.open.toFixed(2) + '</b><br/>' +
                        'æ”¶ç›˜: <b>' + item.close.toFixed(2) + '</b><br/>' +
                        'æœ€é«˜: <b>' + item.high.toFixed(2) + '</b><br/>' +
                        'æœ€ä½: <b>' + item.low.toFixed(2) + '</b><br/>' +
                        'æ¶¨è·Œ: <span style="color:' + color + '">' + sign + change.toFixed(2) + ' (' + sign + changePct + '%)</span><br/>' +
                        'æˆäº¤é‡: ' + item.volume.toFixed(2) +
                        '</div>';
                }
            },
            axisPointer: {
                link: [{ xAxisIndex: 'all' }],
                label: { backgroundColor: '#555' }
            },
            grid: [
                { left: 60, right: 30, top: 20, bottom: '30%' },
                { left: 60, right: 30, height: 60, bottom: 50 }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { onZero: false, lineStyle: { color: '#ccc' } },
                    splitLine: { show: false },
                    axisLabel: {
                        fontSize: 11,
                        color: '#666',
                        formatter: function(val) {
                            return val.substring(5);
                        }
                    },
                    min: 'dataMin',
                    max: 'dataMax'
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { onZero: false },
                    axisTick: { show: false },
                    splitLine: { show: false },
                    axisLabel: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: { show: true, areaStyle: { color: ['rgba(250,250,250,0.3)', 'rgba(240,240,240,0.3)'] } },
                    splitLine: { lineStyle: { color: '#eee' } },
                    axisLabel: {
                        fontSize: 11,
                        color: '#666',
                        formatter: function(val) { return val.toFixed(2); }
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                { type: 'inside', xAxisIndex: [0, 1], start: zoomStart, end: zoomEnd },
                { show: true, xAxisIndex: [0, 1], type: 'slider', bottom: 10, height: 25, start: zoomStart, end: zoomEnd,
                  borderColor: '#ccc', fillerColor: 'rgba(13,110,253,0.15)', handleStyle: { color: '#0d6efd' } }
            ],
            series: [
                {
                    name: symbol,
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#dc3545',
                        color0: '#198754',
                        borderColor: '#dc3545',
                        borderColor0: '#198754'
                    },
                    barMaxWidth: 20
                },
                {
                    name: 'Volume',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volData,
                    barMaxWidth: 16,
                    itemStyle: {
                        color: function(params) {
                            return volColors[params.dataIndex] > 0 ? 'rgba(220,53,69,0.5)' : 'rgba(25,135,84,0.5)';
                        }
                    }
                }
            ]
        };

        chartInstance.setOption(option, true);
    }

    async function submitTrade() {
        const action = document.querySelector('input[name="trade-action"]:checked').value;
        const amount = parseFloat(document.getElementById('trade-amount').value);
        const priceStr = document.getElementById('trade-price').value;
        const price = priceStr ? parseFloat(priceStr) : null;

        if (!currentSymbol || !amount) { showToast('è¯·å¡«å†™å®Œæ•´', 'warning'); return; }

        try {
            const res = await fetch('/api/trade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: currentSymbol,
                    amount: amount,
                    price: price,
                    action: action
                })
            });
            const data = await res.json();
            if (res.status === 401) { showLoginView(); return; }
            if (res.ok) {
                showToast('è®¢å•æäº¤æˆåŠŸ! ID: ' + data.order_id + ' çŠ¶æ€: ' + data.order_status, 'success');
                document.getElementById('trade-amount').value = '';
                document.getElementById('trade-price').value = '';
                refreshData();
            } else {
                showToast('äº¤æ˜“å¤±è´¥: ' + data.detail, 'error');
            }
        } catch (e) {
            showToast('ç½‘ç»œé”™è¯¯: ' + e, 'error');
        }
    }
</script>
</body>
</html>
